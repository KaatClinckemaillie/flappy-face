<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bungee+Spice&family=Montserrat&display=swap" rel="stylesheet">
  <title>Controller Flappy Face</title>
</head>
<body>
  <main class="container__mobile">
    <video id="myCamera" autoplay playsinline></video>
    <button class="startButton">Start</button>
    <button class="pictureButton hide">Take picture</button>
    <p class="controller__text hide">Shake your phone to go up!</p>
    <button class="pauseButton hide">Pauze game</button>

    <button class="jump hide">Jump</button>
  </main>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    {

    let socket, targetSocketId, myStream, peerConnection;

    const $myCamera = document.getElementById('myCamera');
    const $peerSelect = document.getElementById('peerSelect');
    const $pictureButton = document.querySelector('.pictureButton');
    const $jumpButton = document.querySelector('.jump');
    const $startButton = document.querySelector('.startButton');

    const $pauseButton = document.querySelector('.pauseButton');
    const $text = document.querySelector('.controller__text');
    let paused = false;
    let photos = false;

    const servers = {
      iceServers: [{
        urls: 'stun:stun.l.google.com:19302'
      }]
    };

    const init = async () => {
      initSocket();

      const constraints = {audio: false, video: { width: 300, height: 300 } };
      myStream = await navigator.mediaDevices.getUserMedia(constraints);
      

      $myCamera.srcObject = myStream;
      $myCamera.onloadedmetadata = () => $myCamera.play();

      $jumpButton.addEventListener('click', e => handleClick(e));
      $jumpButton.addEventListener('touchend', e => handleTouch(e));

      $pictureButton.addEventListener('click', e=> handleClickPicture(e));
      $startButton.addEventListener('click', (e)=> handleClickStart(e));

      $pauseButton.addEventListener('click', (e) => handlePause(e));
      
      
    };
    

    const handlePause = (e) => {
      e.preventDefault();
      console.log('pause')
      paused = !paused;
      if(paused) {
        $pauseButton.innerHTML = 'Play again';
      }else {
        $pauseButton.innerHTML = 'Pauze game';
      }
      socket.emit('pause');
    }

    const handleClickStart = (e) => {
      e.preventDefault();
      callPeer(targetSocketId);
      $startButton.classList.add('hide');
      $pictureButton.classList.remove('hide');
      socket.emit('start')
    }
    const initSocket = () => {
      targetSocketId = getUrlParameter(`id`);
      if (!targetSocketId) {
        alert(`Missing target ID in querystring`);
        return;
      }
      socket = io.connect('/');
      socket.on('connect', () => {
        console.log(`Connected: ${socket.id}`);
      });

      socket.on('peerAnswer', async (myId, answer, peerId) => {
        await handlePeerAnswer(myId, answer, peerId);
      });

      socket.on('peerIce', async (myId, candidate, peerId) => {
        console.log(`Received peerIce from ${peerId}`, candidate);
        await handlePeerIce(myId, candidate, peerId);
      });

      socket.on('stopVideo', () => {
        console.log('stopvideo');

        photos = true;
        $pictureButton.classList.add('hide');
        $jumpButton.classList.remove('hide');
        

        $myCamera.pause();
        myStream.getTracks().forEach(track => track.stop());
        $myCamera.srcObject = myStream;
        $text.classList.remove('hide');
        $pauseButton.classList.remove('hide');

      })

      socket.on('gameOver', () => {
        console.log('gameover')
        $restartButton.classList.remove('hide');
      })

    }
    const handleClick = (e) => {
      e.preventDefault();
      console.log('click')
      socket.emit(`click`, 'yes!');
    }

    const handleClickPicture = (e) => {
      e.preventDefault();
      console.log('click')
      socket.emit('takePicture');
    }

    const handleMotion = (e) => {
      e.preventDefault();
      console.log(e);
      socket.emit(`click`, 'yes!');
    }
    const handlePeerIce = async (myId, candidate, peerId) => {
      if (!candidate) {
        return;
      }
      await peerConnection.addIceCandidate(candidate);
    };

    const handlePeerAnswer = async (myId, answer, peerId) => {
      await peerConnection.setRemoteDescription(answer);
    };
    
      const selectPeer = (clients) => {
      console.log(clients);
      for (const clientId in clients) {
        const isMyOwnId = (clientId === socket.id);
        if (clients.hasOwnProperty(clientId) && !isMyOwnId) {
          console.log(`call selected peer met peer id: ${clientId}`);
          callPeer(clientId);
        }
      } 
    }; 

    const callPeer = async (peerId) => {
      peerConnection = new RTCPeerConnection(servers);
      // add the video stream
      for (const track of myStream.getTracks()) {
        peerConnection.addTrack(track, myStream);
      }
      peerConnection.onicecandidate = (e) => {
        console.log('ice candidate', e.candidate);
        socket.emit('peerIce', peerId, e.candidate);
      };
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      socket.emit('peerOffer', peerId, offer);
    };
 

    const getUrlParameter = name => {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      const results = regex.exec(location.search);
      return results === null ? false : decodeURIComponent(results[1].replace(/\+/g, ' '));
    };

    init();
    }
  </script>
  
</body>
</html>